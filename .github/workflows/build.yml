name: Build and Deploy Docs

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3️⃣ Install Puppeteer
      - name: Install Puppeteer
        run: npm install puppeteer

      # 4️⃣ Start local HTTP server
      - name: Start local HTTP server
        run: python3 -m http.server 8080 --bind 127.0.0.1 &

      # 5️⃣ Render ReSpec document
      - name: Render ReSpec document
        run: |
          npx puppeteer browsers install chrome
          node -e "
          const puppeteer = require('puppeteer');
          (async () => {
            const browser = await puppeteer.launch({ headless: true, args: ['--no-sandbox'] });
            const page = await browser.newPage();
            await page.goto('http://127.0.0.1:8080/index.html', { waitUntil: 'networkidle2' });
            await page.waitForFunction(() => document.respec && document.respec.ready, { timeout: 90000 });
            await page.evaluate(() => document.respec.flush());
            await page.pdf({ path: 'snapshot.pdf', format: 'A4', printBackground: true });
            await page.screenshot({ path: 'snapshot.png', fullPage: true });
            await page.content().then(c => require('fs').writeFileSync('snapshot.html', c));
            await browser.close();
          })();"

      # 6️⃣ Prepare docs folder
      - name: Prepare docs folder
        run: |
          rm -rf docs/* || true
          mkdir -p docs
          cp snapshot.html docs/index.html
          cp snapshot.pdf docs/
          cp snapshot.png docs/
          cp -r css js media md docs/ || true
          touch docs/.nojekyll

      # 7️⃣ Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          user_name: github-actions[bot]
          user_email: github-actions[bot]@users.noreply.github.com
