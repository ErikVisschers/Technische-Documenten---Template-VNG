name: Build & Publish

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Puppeteer Chrome
        uses: actions/cache@v4
        with:
          path: ~/.cache/puppeteer
          key: puppeteer-${{ runner.os }}-chrome-142

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb curl
          npm ci

      - name: Start static server
        run: |
          npx http-server -p 8080 --silent &
          echo $! > server.pid

      - name: Wait for server
        run: |
          for i in {1..20}; do
            if curl -sS http://127.0.0.1:8080 > /dev/null; then
              echo "server ready"
              break
            fi
            echo "waiting... ($i)"
            sleep 3
          done

      - name: Generate snapshots (HTML, PNG, PDF)
        run: |
          cat > build.js << 'EOF'
          const puppeteer = require('puppeteer');
          (async () => {
            const browser = await puppeteer.launch({
              headless: "new",
              args: ["--no-sandbox", "--disable-setuid-sandbox"]
            });

            const page = await browser.newPage();

            // LOG ALL FAILURES
            page.on("pageerror", err => console.log("Page error:", err));
            page.on("console", msg => console.log("Console:", msg.text()));
            page.on("requestfailed", req =>
              console.log("Request failed:", req.url(), req.failure().errorText)
            );

            await page.goto("http://127.0.0.1:8080/index.html", {
              waitUntil: "networkidle2"
            });

            // WAIT FOR BASIC DOM
            await page.waitForSelector("section", { timeout: 5000 });

            // WAIT FOR RESPEC
            try {
              await page.evaluate(async () => {
                await window.respec.ready;
                await window.respec.flush();
              });
            } catch (err) {
              console.log("ReSpec did not signal ready, using fallback:", err);
              await new Promise(r => setTimeout(r, 10000));
            }

            // PREVENT EMPTY DOCUMENTS
            const html = await page.content();
            if (!html.includes("<section")) {
              throw new Error("ReSpec output seems empty â€” aborting build");
            }

            // SAVE OUTPUTS
            const fs = require("fs");
            fs.mkdirSync("snapshots", { recursive: true });

            fs.writeFileSync("snapshots/index.html", html);
            await page.screenshot({ path: "snapshots/screenshot.png", fullPage: true });
            await page.pdf({ path: "snapshots/document.pdf", format: "A4" });

            await browser.close();
          })();
          EOF

          node build.js

      - name: Prepare docs output
        run: |
          mkdir -p docs
          rsync -av snapshots/ docs/

      - name: Upload website artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Cleanup
        run: kill $(cat server.pid)
